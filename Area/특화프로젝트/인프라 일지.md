
- ssh 접속 MobaXterm 사용
- 포트 상황
	- 22
	- 80
	- 443
	- 3306 : MySQL
	- 6379 : Redis
	- 8080 : 젠킨스 사용자 - 젠킨스 마스터
	- 8989 : gerrit 사용안함
	- 50000 : 젠킨스 마스터 - 젠킨스 에이전트
- 설치됨
	- 도커
	- 젠킨스
		- tools - gradle 8.5 등록
	- MySQL 8.0.35
	- Redis 7.2.4 ( redis.service 작성됨 )
	- NGINX
- 
### 할 일
- 젠킨스 다운로드 실패 했던거 다시 설치하기
- 프론트 빌드 및 배포
- 백 빌드 및 배포
- spring build 방법 공부

### 요일별 기록

#### 24-03-11
1. datetimectl 설정 Asia/Seoul
	- ```sudo datetimectl set-timezone Asia/seoul```
2. 포트 상태
	- 22번 열린 채로 EC2 서버 받음
	- 80번 포트 열었음 ```sudo ufw allow 80```
3. 미러 서버 변경
	- 설정 파일 열기 ```sudo vi /etc/apt/sources.list```
	- 주소 수정 ```:%s/kr.archive.ubuntu.com/mirror.kakao.com/
		- 꼭 kr.archive.ubuntu.com 이 아닐 수 있음 기존 미러서버 주소를 넣으면 됨
	- apt 업데이트 ```sudo apt-get update```
4. nginx 설치
	- 설치 ```sudo apt install nginx -y```
	- 상태 확인 ```sudo systemctl status nginx```
5. SSL 설정(HTTPs 적용 - letsencrypt, Certbot 설치)
	- 설치1 ```sudo apt-get install letsencrypt```
	- 설치2 ```sudo apt-get install certbot python3-certbot-nginx```
	- Certbot-NGINX 연결 ```sudo certbot --nginx```
	- 적용 확인 https://www.ssllabs.com/ssltest/analyze.html?d=j10e201.p.ssafy.io
6. Docker 설치 
	- https://docs.docker.com/engine/install/ubuntu/#install-using-the-repository
```
# Add Docker's official GPG key:
sudo apt-get update
sudo apt-get install ca-certificates curl
sudo install -m 0755 -d /etc/apt/keyrings
sudo curl -fsSL https://download.docker.com/linux/ubuntu/gpg -o /etc/apt/keyrings/docker.asc
sudo chmod a+r /etc/apt/keyrings/docker.asc

# Add the repository to Apt sources:
echo \
  "deb [arch=$(dpkg --print-architecture) signed-by=/etc/apt/keyrings/docker.asc] https://download.docker.com/linux/ubuntu \
  $(. /etc/os-release && echo "$VERSION_CODENAME") stable" | \
  sudo tee /etc/apt/sources.list.d/docker.list > /dev/null
sudo apt-get update

sudo apt-get install docker-ce docker-ce-cli containerd.io docker-buildx-plugin docker-compose-plugin

// test
sudo docker run hello-world
```

7. GPU 서버
	-  아이디 j10e201 비밀번호 j10e201a! 
8. 젠킨스 설치 ( Docker volume 생성 및 로그인 )
	- 도커 볼륨 생성 ```sudo docker volume create myvol```
	- 도커 허브 로그인 ```sudo docker login```
	- 젠킨스 이미지 다운로드 ```docker image pull jenkins/jenkins:latest```
	- 도커 컨테이너 실행 
	- 
	  ```docker run -p 8080:8080 -p 50000:50000 -v myvol:/var/jenkins_home jenkins/jenkins:lts```
	  ```docker run -p 8080:8080 -p 50000:50000 -v myvol:/var/jenkins_home jenkins/jenkins:latest``` 
	- Jenkins initial setup is required. An admin user has been created and a password generated. 
	  This may also be found at: /var/jenkins_home/secrets/initialAdminPassword


#### 24.03.12
- 젠킨스 플러그인 설치
	- Git Plugin
	- Git
	- GitLab
	- PipeLine
	- docker pipeline

#### 24.03.15
1. 도커 mysql 설치
	- 명령어 
		- ```docker pull mysql```
		- ```docker run --name mysql -e MYSQL_ROOT_PASSWORD=<password> -d -p 3306:3306 mysql:latest```
		- ```docker run --name mysql -e MYSQL_ROOT_PASSWORD=<password> -v <우분투에저장된my.cnf경로>:/etc/my.cnf:ro -v <기존에쓰던데이터경로>:/var/lib/mysql -d -p 3306:3306 mysql:8.0.35```
		-  MySQL Docker 컨테이너 접속 $ docker exec -it mysql bash
		-  MySQL Login & 접속
		-  bash-4.4 $ mysql -u root -p
		-  Enter password: $ \<password\>
		- mysql> show databases
	- MySQL Docker 컨테이너 중지 $ docker stop mysql
	- MySQL Docker 컨테이너 시작 $ docker start mysql
	- MySQL Docker 컨테이너 재시작 $ docker restart mysql

CREATE DATABASE sorimaeul CHARACTER SET utf8mb4  COLLATE utf8mb4_unicode_ci;
CREATE USER usagi IDENTIFIED BY 'usagi123!';
GRANT ALL PRIVILEGES ON sorimaeul.* TO usagi;
`allowPublicKeyRetrieval` 값을 `true`

2. mysql서버 - dbeaver 연결
3. Redis Docker 설치
	- ```docker pull redis```
	- ```docker run -p 6379:6379 --name docker_redis redis```
	- redis.service 생성 활성화 및 시작
		- 서비스 파일 내용
		  \[Unit\]
		  Description=Service to run docker container for redis
		  \[Service\]
		  Type=simple
		  ExecStart=sudo docker start docker_redis
		  Restart=on-failure
		  \[Install\]
		  WantedBy=multi-user.target
	1. **시스템D 데몬 리로드**: systemd가 새로운 서비스 파일을s 인식하도록 데몬을 리로드합니다.    `sudo systemctl daemon-reload`
	2. **Redis 서비스 시작**: 다음 명령어로 Redis 서비스를 시작합니다.
	   `sudo systemctl start redis.service`
	3. **Redis 서비스 활성화**: Redis 서비스가 시스템 부팅 시 자동으로 시작되도록 설정합니다. `sudo systemctl enable redis.service`
	4. **서비스 상태 확인**: 서비스가 정상적으로 작동하는지 확인합니다.
	   `sudo systemctl status redis.service`
4. 젠킨스 설정 변경
	- gradle : MyGradle, version: 8.5 설정
```
pipeline {
    agent any
    stages {
        stage('Git Clone') {
            steps {
                git branch: 'back', url: 'https://lab.ssafy.com/s10-ai-speech-sub2/S10P22E201.git', credentialsId: 'wnsgud0895@gmail.com'
            }
        }
        stage('BE-Build') {
            steps {
                dir("./sorimaeul") {
                    // gradlew 파일에 실행 권한 부여
                    sh 'chmod +x ./gradlew'
                    sh "./gradlew clean build"
                }
            }
        }
    }
}
// `clean build` 명령을 실행하면 먼저 이전 빌드에서 생성된 파일들이 모두 삭제되고, 새로운 빌드 과정이 처음부터 시작됩니다. 이는 프로젝트를 깨끗한 상태에서 빌드하고자 할 때 유용합니다.
```

5. 젠킨스 - 백 빌드 성공
	- ssh 에서 막힘

#### 24.03.18
1. backend 프로젝트 CI/CD 구축
	- 파이프라인수정
	- yml 파일수정
	- sh 파일수정
	- 
2. nginx 설정
server {
    listen 80;
    server_name j10e201.p.ssafy.io;
    return 301 https://$host$request_uri;
}

server {
    listen 443 ssl;
    server_name j10e201.p.ssafy.io;
    ssl_certificate /etc/letsencrypt/live/j10e201.p.ssafy.io/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/j10e201.p.ssafy.io/privkey.pem;
    access_log   /var/log/nginx/access.log ;# 에러로그 경로
    error_log    /var/log/nginx/error.log; # 에러로그 경로
    location /api {  # 요청주소 저희는 /api라서 해둠
        proxy_pass http://localhost:8000;
        proxy_set_header Connection '';
        proxy_http_version 1.1;
        #proxy_set_header Host $host;
        #proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        #proxy_set_header X-Real-IP $remote_addr;
        #proxy_set_header X-Forwarded-Host $server_name;
        #proxy_set_header X-Forwarded-Proto $scheme;
    }
    location / {
        proxy_pass http://localhost:3000;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header Connection '';
        proxy_http_version 1.1;
    }
}
// 심볼릭 링크 설정
sudo ln -s /etc/nginx/sites-available/nginxcustom.conf /etc/nginx/sites-enabled/setting

#### 24.03.19
1. MySQL 비밀번호 변경
	- root, usagi 유저에 대해 랜덤 생성기로 비밀번호 변경함
2. MySQL wait_timeout, interactive_timeout, GLOBAL, SESSION 정리
	- wait_timeout 설정
	  mysql> set global wait_timeout=3600; 해도 재시작하면 초기화됨
	- 원하는 경로에 my.conf 파일 만들기
	1. data source 경로 찾기
		- ```docker inspect containerId```
		- "Mounts" : { "Source" : /path/\_data } 경로가 있음 (복사해두기)
	2. 컨테이너 삭제 
		- ```container rm containerId```
	3. 컨테이너 run
		- my.cnf 파일 마운트
		- data source 마운트
	4. 컨테이너 실행
3. 프론트엔드 배포
```
pipeline {
    agent any
    stages {
    stage('Git Clone') {
            steps {
                git branch: 'front', url: 'https://깃경로.git', credentialsId: 'credential이름'
            }
        }
    stage('FE-build') {
        steps {
            dir("./Front") {
                nodejs(nodeJSInstallationName: 'MyNode') {
                    sh '''
                    npm install
                    npm run build
                    '''
                }
            }
        }
    }
    stage('Compression') {
        steps {
            dir("./front") {
                sh '''
                rm -rf node_modules
                rm package-lock.json
                tar -cvf build.tar dist
                '''
            }
        }
    }
    stage('Deploy') {
        steps {
            sshagent(credentials: ['aws_key']) {
                sh '''
                    ssh -o StrictHostKeyChecking=no ubuntu@<ip주소> uptime
                    scp /var/jenkins_home/workspace/<프로젝트명>/FE/build.tar ubuntu@<ip주소>:/home/ubuntu/<프로젝트명>
                    ssh -t ubuntu@<ip주소> ./deployFE.sh
                '''
            }
        }
    }
    }
}
```

4. EC2 Ubuntu에 Node.js 설치
	- curl -fsSL https://deb.nodesource.com/setup_버전.x | sudo -E bash -
	- sudo apt-get install -y nodejs
5. Redis 암호설정
	- docker run --name docker_redis -v /path/to/your/redis.conf:/usr/local/etc/redis/redis.conf -d redis redis-server /usr/local/etc/redis/redis.conf
	- docker run -p 6379:6379 --name docker_redis redis